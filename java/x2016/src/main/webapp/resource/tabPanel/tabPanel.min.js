var TabPanel=function(){};(function($){var container,config={},idCache={},tabCount=0,tabCache={header:[],body:[]};var header,body,footer;var parseTpl=function(tpl,obj){return tpl.replace(/\{([^}]+)\}/g,function(o,i){return obj[i]||''})};var isIE6=!$.support.opacity&&!$.support.style&&window.XMLHttpRequest==undefined;var toInt=function(o){return!isNaN(parseInt(o))?parseInt(o):0};var getPx=function(o){return toInt(o.css('margin-top'))+toInt(o.css('margin-bottom'))+toInt(o.css('border-top-width'))+toInt(o.css('border-bottom-width'))};var getHpx=function(o){return toInt(o.css('margin-left'))+toInt(o.css('margin-right'))+toInt(o.css('border-right-width'))+toInt(o.css('border-left-width'))};var scripts=document.getElementsByTagName('script');var curScript=scripts[scripts.length-1];var __DIR__=curScript.src.substring(0,curScript.src.lastIndexOf('/')+1);var calcTab=function(){while(parseInt(header.attr('iw'))>parseInt(header.attr('w'))){this.removeTab(config.owIndex)}};TabPanel=function(id,conf){container=$(id);var dftConfig={max:-1,defaultIcon:null,showClose:false,owIndex:1,blankImg:__DIR__+"skin/blank.gif",tpl:{hd:'<li id="{id}" class="{closeCls}"><s class="il"></s><s class="ir"></s>{icon}{title}{closeicon}</li>',bd:'<iframe src="{url}" frameborder="0" scrolling="auto" border="0" id="{id}_body"  width="100%"></iframe>'}};if(!container.length||!container[0].nodeType){return alert('无法渲染，容器不存在！')}config=$.extend(dftConfig,conf);if(isNaN(parseInt(config.max))){config.max=dftConfig.max}if(!config.tpl||!config.hd||!config.bd){config.tpl=dftConfig.tpl}if(isNaN(parseInt(config.owIndex))){config.owIndex=dftConfig.owIndex}config.owIndex=Math.min(Math.max(config.owIndex,0),config.max-1);container.addClass('tabpanel');var oHeader=$('<div class="tab-header"><s class="l"></s><s class="r"></s><ul style="margin-top:0px;"></ul></div>').appendTo(container);header=oHeader.find('ul').eq(0);header.attr('w',header.width());header.attr('iw',0);body=$('<div class="tab-body"></div>').appendTo(container);header.click($.proxy(this.headerClick,this));var otherHeight=getPx(oHeader)+oHeader.height()+getPx(body);body.height(container.height()-otherHeight);var _this=this;$(window).resize(function(){header.attr('w',header.width());calcTab.call(_this);body.hide().height(container.height()-otherHeight).show()})};TabPanel.prototype={showTab:function(conf,reload){this.hasTab(conf)?this.activeTab(conf,reload):this.addTab(conf);return this},activeTab:function(conf,reload){var id=this.getId(conf);$.each(tabCache.header,function(){this.removeClass('active')});var hd=$('#'+id).addClass('active');$.each(tabCache.body,function(){this.css('display','none')});var bd=$('#'+id+'_body').css('display','block');if(reload){var ifrm=bd.get(0),src=ifrm.src;ifrm.src="javascript:false";ifrm.src=conf.url||src}if($.isFunction(config.onActive)){config.onActive.apply(this,[id,hd,bd])}return this},addTab:function(conf){if(parseInt(config.max)>0&&tabCount>=parseInt(config.max)){this.removeTab(config.owIndex)}var id=this.getId(conf);var icon=conf.icon||config.defaultIcon;icon=isIE6?"<img src='"+config.blankImg+"' style=\"filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image', src='"+icon+"')\" />":"<img src='"+icon+"' />";var showClose=conf.showClose==undefined?config.showClose:conf.showClose;var closeicon=showClose?"<s class='close'>关闭</s>":'';var data=$.extend(conf,{id:id,icon:icon,closeicon:closeicon,closeCls:showClose?'closeCls':''});var hd,bd;tabCache.header.push(hd=$(parseTpl(config.tpl.hd,data)).appendTo(header));tabCache.body.push(bd=$(parseTpl(config.tpl.bd,data)).appendTo(body));tabCount++;header.attr('iw',parseInt(header.attr('iw'))+parseInt(hd.attr('w',hd.outerWidth()+getHpx(hd)).attr('w')));calcTab.call(this);this.activeTab(conf);if($.isFunction(config.onAdd)){config.onAdd.apply(this,[id,hd,bd])}return this},removeTab:function(index,autoActive){if(!tabCache.header[index]){return}this.fixIFrame(tabCache.body[index]);var hd=tabCache.header[index].remove();var bd=tabCache.body[index].remove();header.attr('iw',header.attr('iw')-hd.attr('w'));tabCache.header.splice(index,1);tabCache.body.splice(index,1);--tabCount;try{CollectGarbage()}catch(e){}if($.isFunction(config.onRemove)){config.onRemove.apply(this,[hd.attr('id'),hd,bd])}if(autoActive){var active=(index==tabCount)?index-1:index;this.activeTab(tabCache.header[active].attr('id'))}return this},hasTab:function(conf){return $('#'+this.getId(conf)).length},getId:function(conf){if(conf.id){return conf.id}if(!conf||!conf.url||typeof conf=='string'){return conf||''}return idCache[conf.url]||(idCache[conf.url]=conf.url.replace(/[\/\.\?\&\:\=]/g,'_'))},fixIFrame:function(iframe){iframe=$(iframe);if(!iframe.length){return}if(iframe.get(0).tagName.toLowerCase()!='iframe'){iframe=iframe.find('iframe')}if(iframe.length>0){iframe.each(function(){this.src="javascript:false"})}},getIndexById:function(id){var index=-1;$.each(tabCache.header,function(i){if(this.attr('id')==id){index=i;return false}});return index},headerClick:function(e){var target=e.target,tagName=target.tagName.toLowerCase(),action='active';if($(target).hasClass('close')){action='remove'}if(tagName=='span'||tagName=='s'){target=$(target).parent('li').get(0)}if(target.tagName.toLowerCase()!='li'){return}action=='active'?this.activeTab(target.id):this.removeTab(this.getIndexById(target.id),true)}}})(jQuery);